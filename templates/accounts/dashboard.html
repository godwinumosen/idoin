{% extends "base.html" %}
{% load static %}
{% block content %}

<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
    <div class="container">
        <a class="navbar-brand fw-bold" href="#">Directory Dashboard</a>
        <div class="ms-auto">
            <form method="post" action="{% url 'logout' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-warning">Logout</button>
            </form>
        </div>
    </div>
</nav>

<div class="container">
    <div class="card shadow-sm p-4">
        <h2 class="mb-4">Welcome, {{ user.username }}!</h2>

        {% if user.is_vendor and user.vendorprofile %}

            <!-- ACCOUNT STATUS -->
            <div class="mb-3">
                <strong>Status:</strong> 
                <span class="badge 
                    {% if user.status == 'pending' %}bg-secondary
                    {% elif user.status == 'approved' %}bg-success
                    {% elif user.status == 'rejected' %}bg-danger
                    {% endif %}">
                    {{ user.get_status_display }}
                </span>
            </div>

            <!-- PROFILE IMAGE -->
            {% if user.vendorprofile.profile_image %}
                <div class="mb-3">
                    <img src="{{ user.vendorprofile.profile_image.url }}" 
                         class="img-fluid rounded shadow-sm" 
                         style="max-width:200px;">
                </div>
            {% endif %}

            <!-- PROFILE DETAILS -->
            <div class="mb-3">
                <strong>Business Name:</strong> {{ user.vendorprofile.business_name }}
            </div>

            <div class="mb-3">
                <strong>Bio:</strong> {{ user.vendorprofile.bio }}
            </div>

            <div class="mb-3">
                <strong>Location:</strong> {{ user.vendorprofile.location }}
            </div>

            <a href="{% url 'edit_profile' %}" class="btn btn-warning mb-4">
                Edit Profile
            </a>

            <hr>

            <!-- GALLERY SECTION -->
            <h4 class="mb-3">Gallery</h4>

            <!-- Image Counter -->
            <p>
                <strong>Images:</strong> 
                {{ user.vendorprofile.gallery.count }} / 10
            </p>

            <!-- Upload Restrictions -->
            {% if user.status != "approved" %}
                <div class="alert alert-warning">
                    Your account must be approved before uploading images.
                </div>
            {% elif user.vendorprofile.gallery.count >= 10 %}
                <div class="alert alert-danger">
                    You have reached the maximum of 10 images.
                </div>
            {% else %}
                <form method="POST" 
                      action="{% url 'upload_image' %}" 
                      enctype="multipart/form-data"
                      class="mb-4">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="file" name="image" class="form-control" required>
                        <button type="submit" class="btn btn-dark">
                            Upload
                        </button>
                    </div>
                </form>
            {% endif %}

            <!-- Gallery Grid -->
            <div class="row">
                {% for img in user.vendorprofile.gallery.all %}
                    <div class="col-md-3 mb-4 text-center">

                        <img src="{{ img.image.url }}" 
                             class="img-fluid rounded shadow-sm mb-2">

                        <!-- Image Status Badge -->
                        <div class="mb-2">
                            <span class="badge
                                {% if img.status == 'pending' %}bg-secondary
                                {% elif img.status == 'approved' %}bg-success
                                {% elif img.status == 'rejected' %}bg-danger
                                {% endif %}">
                                {{ img.get_status_display }}
                            </span>
                        </div>

                        <!-- Delete Button -->
                        <a href="{% url 'delete_image' img.id %}" 
                           class="btn btn-sm btn-danger">
                            Delete
                        </a>

                    </div>
                {% empty %}
                    <p>No images uploaded yet.</p>
                {% endfor %}
            </div>

        {% else %}
            <p>You are registered as a regular user.</p>
        {% endif %}
    </div>
</div>

{% endblock %}